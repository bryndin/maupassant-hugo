{{/*
    This is the search page template.
    It provides a search interface and uses JavaScript to query an
    `index.xml` file client-side to display results.
*/}}
{{ define "content" }}
  {{- $page := . -}}
  {{ "<!-- starting of search/single.html -->" | safeHTML }}
  {{- $datetime_format := i18n "Datetime_format" -}}
  <h3 class="archive-title">
    {{ i18n "Search" }}
    <span class="keyword">{{ i18n "Search_keyword" }}</span>
    {{ i18n "Search_results" }}
  </h3>

  <div id="search-results">
    <article class="post">
      <header>
        <h1 class="post-title">
          <a href="link">title</a>
        </h1>
      </header>
      {{ if not $page.PublishDate.IsZero }}
        <time
          datetime="{{ $page.PublishDate.UTC.Format "2006-01-02T15:04:05Z07:00" }}"
          class="post-meta meta-date dt-published"
          >{{ time.Format $datetime_format $page.PublishDate }}</time
        >
      {{ end }}
      <div class="post-content">
        overview
        <p class="post-readmore"><a href="link">{{ i18n "continueReading" }}</a></p>
      </div>
    </article>
  </div>

  <script>
    var getUrlParameter = function getUrlParameter(sParam) {
      var sPageURL = window.location.search.substring(1),
        sURLVariables = sPageURL.split('&'),
        sParameterName,
        i;

      for (i = 0; i < sURLVariables.length; i++) {
        sParameterName = sURLVariables[i].split('=');

        if (sParameterName[0] === sParam) {
          return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
        }
      }
    };

    $(document).ready(function () {
      var q = getUrlParameter("q");
      $("span.keyword").text(q);
      var resultsContainer = $("#search-results");
      resultsContainer.empty();

      if (!q) {
        resultsContainer.append('<p>{{ i18n "Search_no_query" | default "Please enter a search query." }}</p>');
        return;
      }

      resultsContainer.append('<p id="search-status">{{ i18n "Searching" | default "Searching..." }}</p>');

      $.ajax({
        url: '{{"search.json"|absURL}}',
        dataType: "json",
        success: function (data) {
          $("#search-status").remove();
          var searchResults = [];
          var queryLower = q.toLowerCase();

          $.each(data, function (index, item) {
            var title = item.title;
            var content = item.content;

            if (title.toLowerCase().indexOf(queryLower) >= 0 || content.toLowerCase().indexOf(queryLower) >= 0) {
              var url = item.permalink;
              var pubDate = new Date(item.date);
              var searchItem = `<article class="post"><header><h1 class="post-title"><a href="` + url + `">` + title + `</a></h1></header>`;

              // Only show date if it's valid (not epoch 0 or invalid)
              if (!isNaN(pubDate.getTime()) && pubDate.getFullYear() > 1970) {
                var month = pubDate.getMonth() + 1;
                var day = pubDate.getDate();
                var formattedDate = pubDate.getFullYear() + '-' + (month < 10 ? '0' : '') + month + '-' + (day < 10 ? '0' : '') + day;
                searchItem += `<time class="post-meta meta-date">` + formattedDate + `</time>`;
              }

              // Use the pre-calculated summary from Hugo
              var summary = item.summary;
              // Fallback if summary is empty
              if (!summary && content) {
                summary = content.substring(0, 300) + '...';
              }

              searchItem += `<div class="post-content">` + summary + `<p class="post-readmore"><a href="` + url + `">` + "{{ i18n "continueReading" }}" + `</a></p></div></article>`;

              searchResults.push(searchItem);
            }
          });

          if (searchResults.length > 0) {
            resultsContainer.append(searchResults.join(''));
          } else {
            resultsContainer.append('<p>{{ i18n "No_results_found" | default "No results found for \"" }}' + q + '{{ i18n "No_results_found_end" | default "\"" }}</p>');
          }
        },
        error: function () {
          $("#search-status").remove();
          resultsContainer.append('<p>{{ i18n "Search_error" | default "Error loading search index. Please try again later." }}</p>');
        }
      });
    });
  </script>
  {{ "<!-- ending of search/single.html -->" | safeHTML }}
{{ end }}
