{{/*
    This is the search page template.
    It provides a search interface and uses JavaScript to query an
    `index.xml` file client-side to display results.
*/}}
{{ define "content" }}
  {{- $page := . -}}
  {{ "<!-- starting of search/single.html -->" | safeHTML }}
  {{- $datetime_format := i18n "Datetime_format" -}}
  <h2 class="archive-title">
    {{ i18n "Search" }}
    <span class="search-keyword">{{ i18n "Search_keyword" }}</span>
    {{ i18n "Search_results" }}
  </h2>

  <div id="search-results">
  </div>

  {{/* Template for search results */}}
  <template id="search-result-template">
    <article class="post">
      <header>
        <h1 class="post__title">
          <a class="post__link"></a>
        </h1>
      </header>
      <div class="post-meta">
        <time class="post-meta__date dt-published"></time>
      </div>
      <div class="post__content">
      </div>
    </article>
  </template>

  <script>
    const datetimeFormat = {{ $datetime_format }}; // Passed from Hugo

    const getUrlParameter = (sParam) => {
      const urlParams = new URL(window.location.href).searchParams;
      return urlParams.get(sParam);
    };

    $(document).ready(function () {
      const q = getUrlParameter("q");
      $("span.search-keyword").text(q);
      const $resultsContainer = $("#search-results");
      const $status = $('<p id="search-status">{{ i18n "Searching" | default "Searching..." }}</p>');

      if (!q) {
        $resultsContainer.append($('<p>').text('{{ i18n "Search_no_query" | default "Please enter a search query." }}'));
        return;
      }

      $resultsContainer.append($status);

      $.ajax({
        url: '{{"search.json"|absURL}}',
        dataType: "json",
        success: function (data) {
          $status.remove();
          $resultsContainer.empty();
          
          const queryLower = q.toLowerCase();
          const seenPermalinks = new Set();
          const searchResults = data.filter(item => {
            if (seenPermalinks.has(item.permalink)) return false;
            
            const title = item.title ? item.title.toLowerCase() : '';
            const content = item.content ? item.content.toLowerCase() : '';
            const isMatch = title.includes(queryLower) || content.includes(queryLower);
            
            if (isMatch) {
              seenPermalinks.add(item.permalink);
            }
            return isMatch;
          });

          if (searchResults.length > 0) {
            const template = document.getElementById('search-result-template');
            
            searchResults.forEach(item => {
              const clone = template.content.cloneNode(true);
              
              const link = clone.querySelector('.post__link');
              link.href = item.permalink;
              link.textContent = item.title;
              link.title = item.title;

              const pubDate = new Date(item.date);
              const timeEl = clone.querySelector('time');
              if (!isNaN(pubDate.getTime()) && pubDate.getFullYear() > 1970) {
                  const yyyy = pubDate.getFullYear();
                  const mm = String(pubDate.getMonth() + 1).padStart(2, '0');
                  const dd = String(pubDate.getDate()).padStart(2, '0');
                  timeEl.textContent = `${yyyy}-${mm}-${dd}`;
                  timeEl.setAttribute('datetime', pubDate.toISOString());
              } else {
                  clone.querySelector('.post-meta').remove();
              }

              let summary = item.summary;
              if (!summary && item.content) {
                summary = item.content.substring(0, 300) + '...';
              }
              clone.querySelector('.post__content').innerHTML = summary;

              $resultsContainer.append(clone);
            });
          } else {
             const noResultsMsg = '{{ i18n "No_results_found" | default "No results found for" }} "' + q + '" {{ i18n "No_results_found_end" | default "" }}';
             $resultsContainer.append($('<p>').text(noResultsMsg));
          }
        },
        error: function () {
          $status.remove();
          $resultsContainer.append($('<p>').text('{{ i18n "Search_error" | default "Error loading search index. Please try again later." }}'));
        }
      });
    });
  </script>
  {{ "<!-- ending of search/single.html -->" | safeHTML }}
{{ end }}
