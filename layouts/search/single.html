{{/*
    This is the search page template.
    It provides a search interface and uses JavaScript to query an
    `index.xml` file client-side to display results.
*/}}
{{ define "content" }}
  {{- $page := . -}}
  {{ "<!-- starting of search/single.html -->" | safeHTML }}
  {{- $datetime_format := i18n "Datetime_format" -}}
  <h2 class="archive-title">
    {{ i18n "Search" }}
    <span class="search-keyword">{{ i18n "Search_keyword" }}</span>
    {{ i18n "Search_results" }}
  </h2>

  <div id="search-results">
  </div>

  {{/* Template for search results */}}
  <template id="search-result-template">
    <article class="post">
      <header>
        <h1 class="post-title">
          <a class="post-link"></a>
        </h1>
      </header>
      <time class="post-meta meta-date dt-published"></time>
      <div class="post-content">
        <span class="post-summary"></span>
        <p class="post-readmore"><a class="post-readmore-link">{{ i18n "continueReading" }}</a></p>
      </div>
    </article>
  </template>

  <script>
    const datetimeFormat = {{ $datetime_format }}; // Passed from Hugo

    const getUrlParameter = (sParam) => {
      const urlParams = new URL(window.location.href).searchParams;
      return urlParams.get(sParam);
    };

    $(document).ready(function () {
      const q = getUrlParameter("q");
      $("span.search-keyword").text(q);
      const $resultsContainer = $("#search-results");
      const $status = $('<p id="search-status">{{ i18n "Searching" | default "Searching..." }}</p>');

      if (!q) {
        $resultsContainer.append($('<p>').text('{{ i18n "Search_no_query" | default "Please enter a search query." }}'));
        return;
      }

      $resultsContainer.append($status);

      $.ajax({
        url: '{{"search.json"|absURL}}',
        dataType: "json",
        success: function (data) {
          $status.remove();
          
          const queryLower = q.toLowerCase();
          const searchResults = data.filter(item => {
            const title = item.title ? item.title.toLowerCase() : '';
            const content = item.content ? item.content.toLowerCase() : '';
            return title.includes(queryLower) || content.includes(queryLower);
          });

          if (searchResults.length > 0) {
            const template = document.getElementById('search-result-template');
            
            searchResults.forEach(item => {
              const clone = template.content.cloneNode(true);
              
              const link = clone.querySelector('.post-link');
              link.href = item.permalink;
              link.textContent = item.title;

              const readmoreLink = clone.querySelector('.post-readmore-link');
              readmoreLink.href = item.permalink;

              const pubDate = new Date(item.date);
              const timeEl = clone.querySelector('time');
              if (!isNaN(pubDate.getTime()) && pubDate.getFullYear() > 1970) {
                  // Basic formatting yyyy-mm-dd to match previous behavior or use simplified localestring
                  // Previous: yyyy-mm-dd
                  const yyyy = pubDate.getFullYear();
                  const mm = String(pubDate.getMonth() + 1).padStart(2, '0');
                  const dd = String(pubDate.getDate()).padStart(2, '0');
                  timeEl.textContent = `${yyyy}-${mm}-${dd}`;
                  timeEl.setAttribute('datetime', pubDate.toISOString());
              } else {
                  timeEl.remove();
              }

              let summary = item.summary;
              if (!summary && item.content) {
                summary = item.content.substring(0, 300) + '...';
              }
              // summary is likely HTML-safe from Hugo, but if we want to be super safe we should textContent it
              // However, summaries often contain HTML. 
              // The previous code utilized string concatenation which treated summary as HTML.
              // We will use .innerHTML for summary to preserve formatting if it exists, 
              // BUT we must trust the source (search.json build process).
              // If search.json is trusted, this is fine.
              clone.querySelector('.post-summary').innerHTML = summary;

              $resultsContainer.append(clone);
            });
          } else {
             const noResultsMsg = '{{ i18n "No_results_found" | default "No results found for" }} "' + q + '" {{ i18n "No_results_found_end" | default "" }}';
             $resultsContainer.append($('<p>').text(noResultsMsg));
          }
        },
        error: function () {
          $status.remove();
          $resultsContainer.append($('<p>').text('{{ i18n "Search_error" | default "Error loading search index. Please try again later." }}'));
        }
      });
    });
  </script>
  {{ "<!-- ending of search/single.html -->" | safeHTML }}
{{ end }}
